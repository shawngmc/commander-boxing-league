<!DOCTYPE html>
<!-- Based on https://stackoverflow.com/a/58552334/3245188 -->
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <div id="card">
      <h3 id="card-name"></h3>
      <img id="card-image" src="" width="100%" onClick="swapImage(event)"/>
      <h5 id="card-type"></h5>
      <hr/>
      <span id="card-text"></span>
      <hr/>
      <b>Links</b>
      <ul>
        <li><a id="scryfall-link" href="" target="_blank">Scryfall</a>
        <li><a id="edhrec-link" href="" target="_blank">EDHREC</a>
        <li><a id="gatherer-link" href="" target="_blank">Gatherer</a>
      </ul>
    </div>
    <div id="message">
      <h3>No card name selected!</h3>
      (Top-Left cell of multi-cell)
    </div>
    <button onClick="setLocation()">Reload/Resync</button>
    <script>
      // imported_scryfall_fields = ["id", "oracle_id", "name", "mana_cost", "cmc", "type_line", "power", "toughness", "colors", "color_identity", "keywords", "set", "collector_number", "rarity", "edhrec_rank", "multiverse_id", "is_double_faced", "oracle_text", "mana_cost_2", "oracle_text_2", "type_line_2", "border_crop_image_uri", "edhrec_url", "gatherer_url", "scryfall_url", "emoji_type", "category", "produced_mana", "colors_2", "border_crop_image_uri_2", "loyalty", "color_indicator", "power_2", "toughness_2", "cmc_2"]
      let card_data = null;

      // Stop the loop when the window isn't focused, and restart when it comes back to focus.
      var isFocused = true;
      window.addEventListener("blur", function() {
        isFocused = false;
      });
      window.addEventListener("focus",function() {
        isFocused = true;
        setLocation();
      });
      function swapImage(event) {
        let element = event.target;
        let dataset = element.dataset;
        if ('image2' in dataset && dataset.image2 !== null && dataset.image2.trim().length > 0) {
          element.src = ((element.src === dataset.image1) ? dataset.image2 : dataset.image1);
        }
      };

      function setLocation() {
        google.script.run
          .withSuccessHandler(function (result) {
            if (result != null) {
              if (card_data === null || result['name'] !== card_data['name']) {
                  card_data = result;
                  document.getElementById("message").style.visibility = "hidden";
                  document.getElementById("card").style.visibility = "visible";
                  let card_image_element = document.getElementById("card-image");
                  card_image_element.src = result['border_crop_image_uri'];
                  if ('border_crop_image_uri_2' in result) {
                    card_image_element.dataset.image1 = result['border_crop_image_uri'];
                    card_image_element.dataset.image2 = result['border_crop_image_uri_2'];
                  } else {
                    card_image_element.dataset.image1 = null;
                    card_image_element.dataset.image2 = null;
                  }
                  document.getElementById("card-name").innerText = result['name'];
                  document.getElementById("card-text").innerText = result['oracle_text'];
                  document.getElementById("card-type").innerText = result['type_line'];
                  document.getElementById("scryfall-link").href = result['scryfall_url'];
                  document.getElementById("edhrec-link").href = result['edhrec_url'];
                  document.getElementById("gatherer-link").href = result['gatherer_url'];
              }
            } else {
              document.getElementById("message").style.visibility = "visible";
              document.getElementById("card").style.visibility = "hidden";
              card_data = null;
            }
            if (isFocused) {
              setTimeout(setLocation, 1000);
            }
          })
          .withFailureHandler(function (err) {
            if (isFocused) {
              setTimeout(setLocation, 500);
            }
          })
          .getCurrentSelectedCard();

      }

      setLocation();

    </script>
  </body>
</html>
